{% extends 'base.html' %}

{% block content %}
<div style="text-align: center;">
    <h1 class="main-title">üîç ANOMALIES</h1>
</div>

{% if no_data %}
<div class="info-box" style="max-width: 800px; margin: 3rem auto;">
    <h3 style="color: white;">üëà Upload Your Solar Data to Get Started</h3>
    <p style="color: white; font-size: 1.1rem;">Use the file uploader in the sidebar to begin analyzing your solar panel performance.</p>
</div>
{% elif error %}
<div class="warning-box" style="max-width: 800px; margin: 3rem auto;">
    <h3>‚ùå Error</h3>
    <p style="font-size: 1.1rem;">{{ error }}</p>
</div>
{% else %}

{% if eff_chart_html %}
<div style="margin-top: 2rem;">
    <h3 class="section-header">‚ö° Efficiency Anomalies by Inverter</h3>
    <div style="background: white; padding: 1.5rem; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
        {{ eff_chart_html|safe }}
    </div>
    <div class="info-box" style="margin-top: 1rem;">
        <h4 style="color: white;">üìä How to Use This Chart</h4>
        <p style="color: white; font-size: 1.05rem;">Use the dropdown menu in the top-right corner to switch between different inverters. 
        The <strong>blue line</strong> shows efficiency over time, and <strong>red X marks</strong> indicate detected anomalies. 
        Hover over data points for detailed information.</p>
    </div>
</div>
{% endif %}

<div style="margin-top: 2rem;">
    <h3 class="section-header">üö® Anomaly Detection Results</h3>
    
    <div class="ai-insight-card">
        <h3>ü§ñ AI Anomaly Analysis</h3>
        <div style="color: #1e40af; font-size: 1.05rem; line-height: 1.9;">
            {{ comprehensive_summary|safe }}
        </div>
    </div>
    
    {% if anomaly_count > 0 %}
    <div class="grid-2" style="margin-top: 1rem;">
        <div class="warning-box">
            <h3 style="color: #1e3a8a; margin-top: 0;">‚ö†Ô∏è Found {{ anomaly_count }} Anomalies ({{ anomaly_pct|floatformat:1 }}% of data)</h3>
            <p style="color: #1e3a8a; font-size: 1.05rem; line-height: 1.7;">These unusual readings might indicate:</p>
            <ul style="color: #1e3a8a; font-size: 1rem; line-height: 1.7;">
                <li><strong>Equipment issues:</strong> Malfunctions or inefficiencies in inverters or panels</li>
                <li><strong>Environmental factors:</strong> Shading from trees, buildings, or passing clouds</li>
                <li><strong>Maintenance needs:</strong> Dust, dirt, or debris accumulation on panels</li>
                <li><strong>Weather events:</strong> Storms, heavy cloud cover, or atmospheric conditions</li>
            </ul>
        </div>
        
        <div>
            <div class="metric-card-yellow">
                <h4 style="color: #1e3a8a; margin: 0;">Anomaly Rate</h4>
                <h2 style="color: #1e3a8a; margin: 0.5rem 0;">{{ anomaly_pct|floatformat:1 }}%</h2>
                <p style="color: #1e3a8a; margin: 0;">{{ anomaly_count }} out of {{ total_rows|floatformat:0 }} readings</p>
            </div>
            
            {% if anomaly_pct < 2 %}
            <div class="success-box">
                <h4 style="margin: 0;">Severity Level</h4>
                <p style="margin: 0.5rem 0 0 0; font-weight: 600;">Low - Normal</p>
            </div>
            {% elif anomaly_pct < 5 %}
            <div class="warning-box">
                <h4 style="margin: 0;">Severity Level</h4>
                <p style="margin: 0.5rem 0 0 0; font-weight: 600;">Moderate</p>
            </div>
            {% else %}
            <div class="warning-box">
                <h4 style="margin: 0;">Severity Level</h4>
                <p style="margin: 0.5rem 0 0 0; font-weight: 600;">High - Review Needed</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    {% if anomaly_dist_html %}
    <h4 class="section-header">üìä Anomaly Distribution Over Time</h4>
    <div style="background: white; padding: 1.5rem; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
        {{ anomaly_dist_html|safe }}
    </div>
    {% endif %}
    
    {% if anomaly_table %}
    <div style="margin-top: 2rem;">
        <details style="background: white; padding: 1rem; border-radius: 10px;">
            <summary style="cursor: pointer; font-weight: 600; color: #1e3a8a; font-size: 1.1rem;">
                üìã View All {{ anomaly_count }} Anomalies
            </summary>
            <div style="margin-top: 1rem; max-height: 400px; overflow-y: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Power (kW)</th>
                            {% if anomaly_table.0.SOURCE_ID %}<th>Inverter</th>{% endif %}
                            {% if anomaly_table.0.EFFICIENCY_PCT %}<th>Efficiency (%)</th>{% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in anomaly_table %}
                        <tr>
                            <td>{{ row.Formatted_Time }}</td>
                            <td>{{ row.Value|floatformat:2 }}</td>
                            {% if row.SOURCE_ID %}<td>{{ row.SOURCE_ID }}</td>{% endif %}
                            {% if row.EFFICIENCY_PCT %}<td>{{ row.EFFICIENCY_PCT|floatformat:2 }}</td>{% endif %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </details>
    </div>
    {% endif %}
    
    {% else %}
    <div class="success-box">
        <h3 style="color: white; margin-top: 0;">‚úÖ All Clear!</h3>
        <p style="color: white; font-size: 1.1rem; line-height: 1.7;">
        No anomalies detected in your solar data. Your system is performing consistently and within normal parameters. 
        This indicates proper maintenance and optimal operating conditions. Keep up the great work!
        </p>
    </div>
    {% endif %}
</div>

{% if inverter_data %}
<div style="margin-top: 2rem;">
    <h3 class="section-header">‚ö° Inverter Performance Grouping</h3>
    
    <div class="blue-card">
        <h4 style="color: #1e3a8a; margin-top: 0;">üìä Understanding Performance Quartiles</h4>
        <p style="font-size: 1.05rem; color: #1e40af; line-height: 1.7;">
        Your inverters have been grouped by performance quartiles using statistical analysis. This helps identify 
        which units are working optimally and which might need attention. Quartiles divide your inverters into 
        four equal groups based on their average power output.
        </p>
    </div>
    
    <div class="grid-2" style="margin-top: 1rem;">
        <div>
            <h4 style="color: white;">üåü Top Performers (75-100%)</h4>
            {% if inverter_data.high %}
            <table>
                <thead>
                    <tr>
                        <th>Inverter</th>
                        <th>Avg Power (kW)</th>
                        <th>Peak Power (kW)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for inv in inverter_data.high %}
                    <tr>
                        <td>S{{ inv.SOURCE_ID_NUMBER|floatformat:0 }}</td>
                        <td>{{ inv.AC_POWER_FIXED|floatformat:2 }}</td>
                        <td>{{ inv.Max_Power|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="success-box" style="margin-top: 0.5rem;">
                <p style="color: white; margin: 0;">‚úÖ These inverters are your best performers!</p>
            </div>
            {% else %}
            <p style="color: white;">No inverters in this category</p>
            {% endif %}
            
            <h4 style="color: white; margin-top: 1.5rem;">üìä Below Average (25-50%)</h4>
            {% if inverter_data.medium_low %}
            <table>
                <thead>
                    <tr>
                        <th>Inverter</th>
                        <th>Avg Power (kW)</th>
                        <th>Peak Power (kW)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for inv in inverter_data.medium_low %}
                    <tr>
                        <td>S{{ inv.SOURCE_ID_NUMBER|floatformat:0 }}</td>
                        <td>{{ inv.AC_POWER_FIXED|floatformat:2 }}</td>
                        <td>{{ inv.Max_Power|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="warning-box" style="margin-top: 0.5rem;">
                <p style="color: #1e3a8a; margin: 0;">‚ö†Ô∏è Monitor these inverters for improvements</p>
            </div>
            {% else %}
            <p style="color: white;">No inverters in this category</p>
            {% endif %}
        </div>
        
        <div>
            <h4 style="color: white;">‚úÖ Above Average (50-75%)</h4>
            {% if inverter_data.medium_high %}
            <table>
                <thead>
                    <tr>
                        <th>Inverter</th>
                        <th>Avg Power (kW)</th>
                        <th>Peak Power (kW)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for inv in inverter_data.medium_high %}
                    <tr>
                        <td>S{{ inv.SOURCE_ID_NUMBER|floatformat:0 }}</td>
                        <td>{{ inv.AC_POWER_FIXED|floatformat:2 }}</td>
                        <td>{{ inv.Max_Power|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="info-box" style="margin-top: 0.5rem;">
                <p style="color: white; margin: 0;">üëç Solid performance from these units</p>
            </div>
            {% else %}
            <p style="color: white;">No inverters in this category</p>
            {% endif %}
            
            <h4 style="color: white; margin-top: 1.5rem;">‚ö†Ô∏è Needs Attention (0-25%)</h4>
            {% if inverter_data.low %}
            <table>
                <thead>
                    <tr>
                        <th>Inverter</th>
                        <th>Avg Power (kW)</th>
                        <th>Peak Power (kW)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for inv in inverter_data.low %}
                    <tr>
                        <td>S{{ inv.SOURCE_ID_NUMBER|floatformat:0 }}</td>
                        <td>{{ inv.AC_POWER_FIXED|floatformat:2 }}</td>
                        <td>{{ inv.Max_Power|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="warning-box" style="margin-top: 0.5rem;">
                <p style="color: #1e3a8a; margin: 0; font-weight: 600;">üîß Priority: These inverters need maintenance or inspection</p>
            </div>
            {% else %}
            <div class="success-box" style="margin-top: 0.5rem;">
                <p style="color: white; margin: 0;">‚úÖ No underperforming inverters detected!</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <h4 style="color: white; margin-top: 1.5rem;">üìã Detailed Performance Summary</h4>
    <div class="blue-card">
        <pre style="color: #1e3a8a; font-size: 0.95rem; overflow-x: auto;">{{ inverter_data.summary|safe }}</pre>
    </div>
</div>
{% endif %}

{% endif %}
{% endblock %}

